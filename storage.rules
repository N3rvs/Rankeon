rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {

    // Avatares de usuario
    match /avatars/{userId}/{fileName} {
      // Cualquiera puede leer los avatares para mostrar perfiles
      allow read;
      // El usuario puede actualizar su propio avatar, o un admin puede hacerlo
      allow write: if request.auth != null && (request.auth.uid == userId || request.auth.token.role == 'admin');
    }

    // Avatares de equipos
    match /teams/{teamId}/avatar/{fileName} {
      allow read;
      // Solo el fundador o un admin puede actualizar el avatar del equipo.
      allow write: if request.auth != null && (
                     get(/databases/(default)/documents/teams/$(teamId)).data.founder == request.auth.uid ||
                     request.auth.token.role == 'admin'
                   );
    }

    // Banners de equipos
    match /teams/{teamId}/banner/{fileName} {
      allow read;
      // Solo el fundador o un admin puede actualizar el banner del equipo.
      allow write: if request.auth != null && (
                     get(/databases/(default)/documents/teams/$(teamId)).data.founder == request.auth.uid ||
                     request.auth.token.role == 'admin'
                   );
    }

    // Denegar todo lo dem√°s por seguridad
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
